@model Assignment.ViewModels.Vouchers.UserVoucherListViewModel
@using Assignment.Enums

@{
    ViewData["Title"] = "Voucher của tôi";
    var privateSection = Model?.PrivateVouchers;
    var privateVouchers = privateSection?.Items ?? Enumerable.Empty<Assignment.ViewModels.Vouchers.VoucherSummaryViewModel>();
    var savedSection = Model?.SavedVouchers;
    var savedVouchers = savedSection?.Items ?? Enumerable.Empty<Assignment.ViewModels.Vouchers.VoucherSummaryViewModel>();
    var referenceTime = ViewBag.ReferenceTime as DateTime? ?? DateTime.Now;
}

<div class="container my-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
        <div>
            <h2 class="mb-1"><i class="fas fa-bookmark me-2 text-warning"></i>Voucher của bạn</h2>
            <p class="text-muted mb-0">Quản lý các mã giảm giá riêng tư và công khai mà bạn đã lưu.</p>
        </div>
        <a class="btn btn-outline-primary mt-3 mt-md-0" asp-action="Public">
            <i class="fas fa-search me-2"></i>Tìm thêm mã giảm giá
        </a>
    </div>

    @if (TempData["Success"] is string successMessage)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @successMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Info"] is string infoMessage)
    {
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            @infoMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Error"] is string errorMessage)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="mb-5">
        <h3 class="h5 mb-3"><i class="fas fa-user-shield me-2 text-info"></i>Voucher dành riêng cho bạn</h3>
        @if (!privateVouchers.Any())
        {
            <div class="alert alert-info">Bạn chưa có voucher riêng tư nào.</div>
        }
        else
        {
            <div class="row g-4">
                @foreach (var voucher in privateVouchers)
                {
                    var isActive = voucher.IsActive(referenceTime);
                    var isAvailable = voucher.IsAvailable;
                    var isPercentage = voucher.DiscountType == Assignment.Enums.VoucherDiscountType.Percent;
                    var productScopeText = voucher.ProductScope switch
                    {
                        VoucherProductScope.AllProducts => "Tất cả sản phẩm",
                        VoucherProductScope.SelectedProducts => "Một số sản phẩm",
                        VoucherProductScope.NoProducts => "Không áp dụng cho sản phẩm",
                        _ => "Không xác định"
                    };
                    var comboScopeText = voucher.ComboScope switch
                    {
                        VoucherComboScope.AllCombos => "Tất cả combo",
                        VoucherComboScope.SelectedCombos => "Một số combo",
                        VoucherComboScope.NoCombos => "Không áp dụng cho combo",
                        _ => "Không xác định"
                    };
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="card h-100 shadow-sm border-info">
                            <div class="card-header bg-info text-white">
                                <div class="d-flex justify-content-between align-items-center gap-2">
                                    <div class="d-flex flex-wrap align-items-center gap-2">
                                        <span><i class="fas fa-lock me-2"></i>Riêng tư</span>
                                        <span class="badge bg-@(isActive ? "success" : "secondary")">@(isActive ? "Đang diễn ra" : "Không hiệu lực")</span>
                                        @if (voucher.IsForNewUsersOnly)
                                        {
                                            <span class="badge bg-dark">Khách hàng mới</span>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">@voucher.Name</h5>
                                <h6 class="card-subtitle mb-2 text-muted">Mã: @voucher.Code</h6>
                                <p class="card-text">@voucher.Description</p>
                                <ul class="list-unstyled small text-muted mb-0">
                                    <li><i class="fas fa-percentage me-2"></i>Loại: @(isPercentage ? "Phần trăm" : "Tiền mặt")</li>
                                    <li>
                                        <i class="fas fa-coins me-2"></i>
                                        Mức giảm: @(isPercentage ? $"{voucher.Discount:N0}%" : $"{voucher.Discount:N0} đ")
                                        @if (isPercentage && !voucher.UnlimitedPercentageDiscount && voucher.MaximumPercentageReduction.HasValue)
                                        {
                                            <span class="d-block ms-4">Tối đa: @voucher.MaximumPercentageReduction.Value.ToString("N0") đ</span>
                                        }
                                    </li>
                                    <li><i class="fas fa-wallet me-2"></i>Đơn tối thiểu: @voucher.MinimumRequirements.ToString("N0") đ</li>
                                    @if (voucher.IsForNewUsersOnly)
                                    {
                                        <li><i class="fas fa-user-plus me-2"></i>Chỉ dành cho khách hàng mới</li>
                                    }
                                    <li><i class="fas fa-boxes me-2"></i>Phạm vi sản phẩm: @productScopeText</li>
                                    <li><i class="fas fa-gifts me-2"></i>Phạm vi combo: @comboScopeText</li>
                                    <li><i class="fas fa-ticket-alt me-2"></i>Lượt sử dụng: @voucher.Used.ToString("N0")/@(voucher.Quantity > 0 ? voucher.Quantity.ToString("N0") : "Không giới hạn")</li>
                                    <li>
                                        <i class="fas fa-clock me-2"></i>
                                        @if (voucher.IsLifeTime)
                                        {
                                            <span>Không giới hạn thời gian</span>
                                        }
                                        else
                                        {
                                            <span>@voucher.StartTime.ToString("dd/MM/yyyy") - @voucher.EndTime?.ToString("dd/MM/yyyy")</span>
                                        }
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                }
            </div>
            @if ((privateSection?.TotalItems ?? 0) > 0)
            {
                var privateInfo = privateSection!;
                <div class="management-pagination mt-4">
                    <div class="management-pagination__summary text-muted small">
                        Hiển thị @privateInfo.StartItem.ToString("N0") - @privateInfo.EndItem.ToString("N0") trong tổng số @privateInfo.TotalItems.ToString("N0") voucher riêng tư.
                    </div>
                    <div class="management-pagination__actions">
                        <a class="btn btn-outline-secondary btn-sm @(privateInfo.HasPrevious ? string.Empty : "disabled")"
                           href="@(privateInfo.HasPrevious ? Url.Action("Mine", new { privatePage = privateInfo.CurrentPage - 1, privatePageSize = privateInfo.PageSize, savedPage = savedSection?.CurrentPage ?? 1, savedPageSize = savedSection?.PageSize ?? 6 }) : "#")"
                           tabindex="@(privateInfo.HasPrevious ? "0" : "-1")"
                           aria-disabled="@(privateInfo.HasPrevious ? "false" : "true")">
                            <i class="fas fa-angle-left me-1"></i>Trước
                        </a>
                        <a class="btn btn-outline-secondary btn-sm @(privateInfo.HasNext ? string.Empty : "disabled")"
                           href="@(privateInfo.HasNext ? Url.Action("Mine", new { privatePage = privateInfo.CurrentPage + 1, privatePageSize = privateInfo.PageSize, savedPage = savedSection?.CurrentPage ?? 1, savedPageSize = savedSection?.PageSize ?? 6 }) : "#")"
                           tabindex="@(privateInfo.HasNext ? "0" : "-1")"
                           aria-disabled="@(privateInfo.HasNext ? "false" : "true")">
                            Sau<i class="fas fa-angle-right ms-1"></i>
                        </a>
                    </div>
                </div>
            }
        }
    </div>

    <div>
        <h3 class="h5 mb-3"><i class="fas fa-bookmark me-2 text-danger"></i>Voucher đã lưu</h3>
        @if (!savedVouchers.Any())
        {
            <div class="alert alert-warning">Bạn chưa lưu mã giảm giá công khai nào.</div>
        }
        else
        {
            <div class="row g-4">
                @foreach (var voucher in savedVouchers)
                {
                    var isActive = voucher.IsActive(referenceTime);
                    var isAvailable = voucher.IsAvailable;
                    var isPercentage = voucher.DiscountType == Assignment.Enums.VoucherDiscountType.Percent;
                    var productScopeText = voucher.ProductScope switch
                    {
                        VoucherProductScope.AllProducts => "Tất cả sản phẩm",
                        VoucherProductScope.SelectedProducts => "Một số sản phẩm",
                        VoucherProductScope.NoProducts => "Không áp dụng cho sản phẩm",
                        _ => "Không xác định"
                    };
                    var comboScopeText = voucher.ComboScope switch
                    {
                        VoucherComboScope.AllCombos => "Tất cả combo",
                        VoucherComboScope.SelectedCombos => "Một số combo",
                        VoucherComboScope.NoCombos => "Không áp dụng cho combo",
                        _ => "Không xác định"
                    };
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="card h-100 shadow-sm border-warning">
                            <div class="card-header bg-warning">
                                <div class="d-flex justify-content-between align-items-center gap-2">
                                    <div class="d-flex flex-wrap align-items-center gap-2">
                                        <span><i class="fas fa-globe me-2"></i>Công khai</span>
                                        <span class="badge bg-@(isActive ? "success" : "secondary")">@(isActive ? "Đang diễn ra" : "Không hiệu lực")</span>
                                        @if (voucher.IsForNewUsersOnly)
                                        {
                                            <span class="badge bg-dark text-white">Khách hàng mới</span>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">@voucher.Name</h5>
                                <h6 class="card-subtitle mb-2 text-muted">Mã: @voucher.Code</h6>
                                <p class="card-text">@voucher.Description</p>
                                <ul class="list-unstyled small text-muted mb-0">
                                    <li><i class="fas fa-percentage me-2"></i>Loại: @(isPercentage ? "Phần trăm" : "Tiền mặt")</li>
                                    <li>
                                        <i class="fas fa-coins me-2"></i>
                                        Mức giảm: @(isPercentage ? $"{voucher.Discount:N0}%" : $"{voucher.Discount:N0} đ")
                                        @if (isPercentage && !voucher.UnlimitedPercentageDiscount && voucher.MaximumPercentageReduction.HasValue)
                                        {
                                            <span class="d-block ms-4">Tối đa: @voucher.MaximumPercentageReduction.Value.ToString("N0") đ</span>
                                        }
                                    </li>
                                    <li><i class="fas fa-wallet me-2"></i>Đơn tối thiểu: @voucher.MinimumRequirements.ToString("N0") đ</li>
                                    @if (voucher.IsForNewUsersOnly)
                                    {
                                        <li><i class="fas fa-user-plus me-2"></i>Chỉ dành cho khách hàng mới</li>
                                    }
                                    <li><i class="fas fa-boxes me-2"></i>Phạm vi sản phẩm: @productScopeText</li>
                                    <li><i class="fas fa-gifts me-2"></i>Phạm vi combo: @comboScopeText</li>
                                    <li><i class="fas fa-ticket-alt me-2"></i>Lượt sử dụng: @voucher.Used.ToString("N0")/@(voucher.Quantity > 0 ? voucher.Quantity.ToString("N0") : "Không giới hạn")</li>
                                    <li>
                                        <i class="fas fa-clock me-2"></i>
                                        @if (voucher.IsLifeTime)
                                        {
                                            <span>Không giới hạn thời gian</span>
                                        }
                                        else
                                        {
                                            <span>@voucher.StartTime.ToString("dd/MM/yyyy") - @voucher.EndTime?.ToString("dd/MM/yyyy")</span>
                                        }
                                    </li>
                                </ul>
                                <div class="d-flex flex-wrap justify-content-between align-items-center mt-3 gap-2">
                                    <span class="badge @(isAvailable ? "bg-success" : "bg-danger")">
                                        @(isAvailable ? "Còn lượt" : "Hết lượt")
                                    </span>
                                    <form asp-action="Unsave" asp-route-id="@voucher.Id" method="post" class="ms-auto">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-outline-danger btn-sm">
                                            <i class="fas fa-times me-1"></i>Bỏ lưu
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
            @if ((savedSection?.TotalItems ?? 0) > 0)
            {
                var savedInfo = savedSection!;
                <div class="management-pagination mt-4">
                    <div class="management-pagination__summary text-muted small">
                        Hiển thị @savedInfo.StartItem.ToString("N0") - @savedInfo.EndItem.ToString("N0") trong tổng số @savedInfo.TotalItems.ToString("N0") voucher đã lưu.
                    </div>
                    <div class="management-pagination__actions">
                        <a class="btn btn-outline-secondary btn-sm @(savedInfo.HasPrevious ? string.Empty : "disabled")"
                           href="@(savedInfo.HasPrevious ? Url.Action("Mine", new { privatePage = privateSection?.CurrentPage ?? 1, privatePageSize = privateSection?.PageSize ?? 6, savedPage = savedInfo.CurrentPage - 1, savedPageSize = savedInfo.PageSize }) : "#")"
                           tabindex="@(savedInfo.HasPrevious ? "0" : "-1")"
                           aria-disabled="@(savedInfo.HasPrevious ? "false" : "true")">
                            <i class="fas fa-angle-left me-1"></i>Trước
                        </a>
                        <a class="btn btn-outline-secondary btn-sm @(savedInfo.HasNext ? string.Empty : "disabled")"
                           href="@(savedInfo.HasNext ? Url.Action("Mine", new { privatePage = privateSection?.CurrentPage ?? 1, privatePageSize = privateSection?.PageSize ?? 6, savedPage = savedInfo.CurrentPage + 1, savedPageSize = savedInfo.PageSize }) : "#")"
                           tabindex="@(savedInfo.HasNext ? "0" : "-1")"
                           aria-disabled="@(savedInfo.HasNext ? "false" : "true")">
                            Sau<i class="fas fa-angle-right ms-1"></i>
                        </a>
                    </div>
                </div>
            }
        }
    </div>
</div>
