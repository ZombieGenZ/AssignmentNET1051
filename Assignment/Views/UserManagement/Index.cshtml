@{
    ViewData["Title"] = "Quản lý người dùng";
    Layout = "_AdminLayout";
}

<div class="container-fluid pt-4 px-4" id="user-management-app">
    <div class="card shadow-sm">
        <div class="card-header bg-light d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
            <div>
                <h4 class="mb-0 text-primary">
                    <i class="fas fa-users-cog me-2"></i>@ViewData["Title"]
                </h4>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary" id="refreshUsersBtn">
                    <i class="fas fa-rotate-right me-1"></i>Tải lại
                </button>
            </div>
        </div>
        <div class="card-body">
            <div id="userAlert"></div>
            <div class="row g-3 mb-3 align-items-end">
                <div class="col-12 col-md-4">
                    <label class="form-label" for="userSearchInput">Tìm kiếm</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="search" class="form-control" id="userSearchInput" placeholder="Email, tên đăng nhập, họ tên" />
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <label class="form-label" for="userStatusFilter">Trạng thái</label>
                    <select class="form-select" id="userStatusFilter">
                        <option value="">Tất cả</option>
                        <option value="active" selected>Đang hoạt động</option>
                        <option value="locked">Đang khóa</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label" for="userPageSize">Số dòng</label>
                    <select class="form-select" id="userPageSize">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
                <div class="col-12 col-md-3 text-md-end">
                    <span class="text-muted small" id="userTableStatus">Đang tải dữ liệu...</span>
                </div>
            </div>

            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
                <div class="text-muted" id="selectedUsersCount">Đã chọn 0 người dùng.</div>
                <div class="d-flex gap-2 mt-2 mt-md-0">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="bulkEditBtn" disabled>
                        <i class="fas fa-sliders-h me-1"></i>Chỉnh sửa hàng loạt
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="clearSelectionBtn" disabled>
                        <i class="fas fa-xmark me-1"></i>Bỏ chọn
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle" id="userTable">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40px;" class="text-center">
                                <div class="form-check m-0">
                                    <input class="form-check-input" type="checkbox" id="selectAllUsersCheckbox" />
                                </div>
                            </th>
                            <th>Email</th>
                            <th>Tên đăng nhập</th>
                            <th>Họ tên</th>
                            <th>Vai trò</th>
                            <th style="width: 140px;">Trạng thái BXH</th>
                            <th style="width: 90px;">Booster</th>
                            <th style="width: 150px;">Trạng thái</th>
                            <th style="width: 150px;">Khóa đến</th>
                            <th style="width: 120px;" class="text-center">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <tr>
                            <td colspan="10" class="text-center py-4 text-muted">Đang tải dữ liệu...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mt-3 management-pagination">
                <div class="text-muted management-pagination__summary" id="userTableSummary"></div>
                <nav class="management-pagination__actions">
                    <ul class="pagination pagination-sm mb-0" id="userPagination"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<form id="userAntiForgeryForm" class="d-none">
    @Html.AntiForgeryToken()
</form>

<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">Chi tiết người dùng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="userModalAlert"></div>
                <div class="mb-3">
                    <div class="d-flex flex-column flex-lg-row justify-content-between gap-3">
                        <div>
                            <p class="mb-1"><strong>Email:</strong> <span id="userEmail"></span></p>
                            <p class="mb-1"><strong>Tên đăng nhập:</strong> <span id="userUserName"></span></p>
                            <p class="mb-0"><strong>Họ tên:</strong> <span id="userFullName"></span></p>
                        </div>
                        <div>
                            <p class="mb-1"><strong>Trạng thái:</strong> <span id="userStatus"></span></p>
                            <p class="mb-0"><strong>Khóa đến:</strong> <span id="userLockout"></span></p>
                        </div>
                    </div>
                </div>

                <div id="superAdminWarning" class="alert alert-warning d-none" role="alert">
                    Người dùng này có quyền <strong>superadmin</strong>. Bạn không thể thay đổi vai trò, quyền hoặc trạng thái khóa của họ.
                </div>

                <div class="border rounded p-3 mb-4">
                    <h6 class="text-primary"><i class="fas fa-user-tag me-2"></i>Vai trò</h6>
                    <div id="roleCheckboxContainer" class="row g-2"></div>
                </div>

                <div class="border rounded p-3 mb-4">
                    <h6 class="text-primary"><i class="fas fa-key me-2"></i>Quyền trực tiếp</h6>
                    <div id="permissionCheckboxContainer"></div>
                </div>

                <div class="border rounded p-3 mb-4">
                    <h6 class="text-primary"><i class="fas fa-trophy me-2"></i>Bảng xếp hạng</h6>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="userExcludeFromLeaderboard">
                        <label class="form-check-label" for="userExcludeFromLeaderboard">Ẩn khỏi bảng xếp hạng khách hàng</label>
                    </div>
                    <div>
                        <label class="form-label" for="userBoosterInput">Booster</label>
                        <div class="input-group">
                            <span class="input-group-text">x</span>
                            <input type="number" class="form-control" id="userBoosterInput" min="1" step="0.1" value="1" />
                        </div>
                        <div class="form-text">Booster nhân với điểm thưởng và EXP nhận được của khách hàng.</div>
                    </div>
                </div>

                <div class="border rounded p-3">
                    <h6 class="text-primary"><i class="fas fa-lock me-2"></i>Khóa tài khoản</h6>
                    <div class="row g-3 align-items-end" id="lockSection">
                        <div class="col-12 col-md-4">
                            <label class="form-label" for="lockDurationValue">Thời gian</label>
                            <input type="number" class="form-control" id="lockDurationValue" min="1" value="30" />
                        </div>
                        <div class="col-12 col-md-3">
                            <label class="form-label" for="lockDurationUnit">Đơn vị</label>
                            <select class="form-select" id="lockDurationUnit">
                                <option value="minute">Phút</option>
                                <option value="hour">Giờ</option>
                                <option value="day">Ngày</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-5 d-flex gap-2">
                            <button type="button" class="btn btn-outline-danger flex-fill" id="lockUserBtn">
                                <i class="fas fa-lock me-1"></i>Khóa tài khoản
                            </button>
                            <button type="button" class="btn btn-outline-success flex-fill" id="unlockUserBtn">
                                <i class="fas fa-unlock me-1"></i>Mở khóa
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="saveUserChangesBtn">
                    <i class="fas fa-save me-1"></i>Lưu thay đổi
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bulkUserModal" tabindex="-1" aria-labelledby="bulkUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkUserModalLabel">Chỉnh sửa người dùng hàng loạt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="bulkUserAlert"></div>
                <p class="mb-4">Đang áp dụng cho <strong id="bulkSelectedCount">0</strong> người dùng.</p>

                <div class="border rounded p-3 mb-4">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="bulkApplyRoles">
                        <label class="form-check-label" for="bulkApplyRoles">Cập nhật vai trò</label>
                    </div>
                    <div class="mt-3 d-none" id="bulkRolesContainer"></div>
                </div>

                <div class="border rounded p-3 mb-4">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="bulkApplyPermissions">
                        <label class="form-check-label" for="bulkApplyPermissions">Cập nhật quyền trực tiếp</label>
                    </div>
                    <div class="mt-3 d-none" id="bulkPermissionsContainer"></div>
                </div>

                <div class="border rounded p-3 mb-4">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="bulkApplyExclude">
                        <label class="form-check-label" for="bulkApplyExclude">Cập nhật hiển thị bảng xếp hạng</label>
                    </div>
                    <div class="mt-3 ms-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="bulkExcludeCheckbox" disabled>
                            <label class="form-check-label" for="bulkExcludeCheckbox">Ẩn khỏi bảng xếp hạng khách hàng</label>
                        </div>
                    </div>
                </div>

                <div class="border rounded p-3 mb-4">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="bulkApplyBooster">
                        <label class="form-check-label" for="bulkApplyBooster">Cập nhật booster</label>
                    </div>
                    <div class="mt-3 ms-4">
                        <div class="input-group">
                            <span class="input-group-text">x</span>
                            <input type="number" class="form-control" id="bulkBoosterInput" min="1" step="0.1" value="1" disabled>
                        </div>
                        <div class="form-text">Áp dụng cùng một booster cho các tài khoản đã chọn.</div>
                    </div>
                </div>

                <div class="border rounded p-3">
                    <label class="form-label" for="bulkLockAction">Khóa tài khoản</label>
                    <select class="form-select" id="bulkLockAction">
                        <option value="none" selected>Không thay đổi</option>
                        <option value="lock">Khóa tài khoản</option>
                        <option value="unlock">Mở khóa tài khoản</option>
                    </select>
                    <div class="row g-3 align-items-end mt-2 d-none" id="bulkLockFields">
                        <div class="col-6 col-md-4">
                            <label class="form-label" for="bulkLockDurationValue">Thời gian</label>
                            <input type="number" class="form-control" id="bulkLockDurationValue" min="1" value="30">
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="form-label" for="bulkLockDurationUnit">Đơn vị</label>
                            <select class="form-select" id="bulkLockDurationUnit">
                                <option value="minute">Phút</option>
                                <option value="hour">Giờ</option>
                                <option value="day">Ngày</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="bulkUserSaveBtn">
                    <i class="fas fa-save me-1"></i>Áp dụng
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (() => {
            const app = document.getElementById('user-management-app');
            if (!app) {
                return;
            }

            const userTableBody = document.getElementById('userTableBody');
            const paginationEl = document.getElementById('userPagination');
            const tableSummary = document.getElementById('userTableSummary');
            const statusText = document.getElementById('userTableStatus');
            const alertPlaceholder = document.getElementById('userAlert');
            const searchInput = document.getElementById('userSearchInput');
            const statusFilter = document.getElementById('userStatusFilter');
            const pageSizeSelect = document.getElementById('userPageSize');
            const refreshBtn = document.getElementById('refreshUsersBtn');
            const selectAllUsersCheckbox = document.getElementById('selectAllUsersCheckbox');
            const selectedUsersCountText = document.getElementById('selectedUsersCount');
            const bulkEditBtn = document.getElementById('bulkEditBtn');
            const clearSelectionBtn = document.getElementById('clearSelectionBtn');

            const userModalEl = document.getElementById('userModal');
            const userModal = new bootstrap.Modal(userModalEl);
            const userModalAlert = document.getElementById('userModalAlert');
            const userEmailEl = document.getElementById('userEmail');
            const userUserNameEl = document.getElementById('userUserName');
            const userFullNameEl = document.getElementById('userFullName');
            const userStatusEl = document.getElementById('userStatus');
            const userLockoutEl = document.getElementById('userLockout');
            const superAdminWarning = document.getElementById('superAdminWarning');
            const roleContainer = document.getElementById('roleCheckboxContainer');
            const permissionContainer = document.getElementById('permissionCheckboxContainer');
            const userExcludeFromLeaderboard = document.getElementById('userExcludeFromLeaderboard');
            const userBoosterInput = document.getElementById('userBoosterInput');
            const lockSection = document.getElementById('lockSection');
            const lockDurationValue = document.getElementById('lockDurationValue');
            const lockDurationUnit = document.getElementById('lockDurationUnit');
            const lockUserBtn = document.getElementById('lockUserBtn');
            const unlockUserBtn = document.getElementById('unlockUserBtn');
            const saveUserChangesBtn = document.getElementById('saveUserChangesBtn');

            const bulkUserModalEl = document.getElementById('bulkUserModal');
            const bulkUserModal = bulkUserModalEl ? new bootstrap.Modal(bulkUserModalEl) : null;
            const bulkUserAlert = document.getElementById('bulkUserAlert');
            const bulkSelectedCount = document.getElementById('bulkSelectedCount');
            const bulkApplyRoles = document.getElementById('bulkApplyRoles');
            const bulkRolesContainer = document.getElementById('bulkRolesContainer');
            const bulkApplyPermissions = document.getElementById('bulkApplyPermissions');
            const bulkPermissionsContainer = document.getElementById('bulkPermissionsContainer');
            const bulkApplyExclude = document.getElementById('bulkApplyExclude');
            const bulkExcludeCheckbox = document.getElementById('bulkExcludeCheckbox');
            const bulkApplyBooster = document.getElementById('bulkApplyBooster');
            const bulkBoosterInput = document.getElementById('bulkBoosterInput');
            const bulkLockActionSelect = document.getElementById('bulkLockAction');
            const bulkLockFields = document.getElementById('bulkLockFields');
            const bulkLockDurationValue = document.getElementById('bulkLockDurationValue');
            const bulkLockDurationUnit = document.getElementById('bulkLockDurationUnit');
            const bulkUserSaveBtn = document.getElementById('bulkUserSaveBtn');

            const antiForgeryForm = document.getElementById('userAntiForgeryForm');
            const requestToken = () => antiForgeryForm.querySelector('input[name="__RequestVerificationToken"]').value;

            const state = {
                page: 1,
                pageSize: parseInt(pageSizeSelect.value, 10),
                status: statusFilter.value,
                keyword: '',
                selectedUserId: null,
                rolesCache: [],
                currentPermissions: [],
                isSuperAdmin: false,
                permissionsCache: [],
                selectedUserIds: new Set(),
            };

            const updatePermissionVisibility = () => {
                const checkboxes = Array.from(permissionContainer.querySelectorAll('.user-permission-checkbox'));
                const map = new Map();
                checkboxes.forEach(checkbox => {
                    const container = checkbox.closest('[data-permission-item]');
                    if (container) {
                        container.style.display = '';
                    }
                    map.set(checkbox.value, checkbox);
                });

                checkboxes.forEach(checkbox => {
                    if (!checkbox.value.endsWith('All')) {
                        return;
                    }

                    const baseKey = checkbox.value.slice(0, -3);
                    const baseCheckbox = map.get(baseKey);
                    if (!baseCheckbox) {
                        return;
                    }

                    const baseContainer = baseCheckbox.closest('[data-permission-item]');
                    if (!baseContainer) {
                        return;
                    }

                    const isInherited = checkbox.dataset.isInherited === 'true';
                    const shouldHide = checkbox.checked || checkbox.indeterminate || isInherited;
                    if (shouldHide) {
                        if (baseCheckbox.dataset.isInherited !== 'true' && !baseCheckbox.disabled) {
                            baseCheckbox.checked = false;
                            baseCheckbox.indeterminate = false;
                        }
                        baseContainer.style.display = 'none';
                    } else {
                        baseContainer.style.display = '';
                    }
                });
            };

            const formatDateTime = (value) => {
                if (!value) {
                    return '<span class="text-muted">-</span>';
                }
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) {
                    const fallback = new Date(value + 'Z');
                    if (!Number.isNaN(fallback.getTime())) {
                        return fallback.toLocaleString('vi-VN');
                    }
                    return '<span class="text-muted">-</span>';
                }
                return date.toLocaleString('vi-VN');
            };

            const formatBooster = (value) => {
                const numeric = Number(value);
                if (!Number.isFinite(numeric) || numeric <= 0) {
                    return 'x1';
                }
                const options = Number.isInteger(numeric)
                    ? undefined
                    : { minimumFractionDigits: 0, maximumFractionDigits: 2 };
                const formatted = options
                    ? numeric.toLocaleString('vi-VN', options)
                    : numeric.toLocaleString('vi-VN');
                return `x${formatted}`;
            };

            const normalizeBoosterValue = (value) => {
                let numeric = Number(value);
                if (!Number.isFinite(numeric) || numeric <= 0) {
                    return 1;
                }

                numeric = Math.round(numeric * 100) / 100;
                if (numeric < 1) {
                    numeric = 1;
                }

                return numeric;
            };

            const syncBoosterInputValue = (input) => {
                if (!input) {
                    return 1;
                }

                const normalized = normalizeBoosterValue(input.value ?? '1');
                input.value = normalized.toString();
                return normalized;
            };

            const renderAlert = (container, message, type = 'success') => {
                if (!container) {
                    return;
                }
                container.innerHTML = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>`;
            };

            const clearAlert = (container) => {
                if (!container) {
                    return;
                }
                container.innerHTML = '';
            };

            const buildQuery = () => {
                const params = new URLSearchParams();
                if (state.keyword) {
                    params.append('keyword', state.keyword);
                }
                if (state.status) {
                    params.append('status', state.status);
                }
                params.append('page', state.page);
                params.append('pageSize', state.pageSize);
                return params.toString();
            };

            const updateSelectionUI = () => {
                const selectedCount = state.selectedUserIds.size;
                if (selectedUsersCountText) {
                    selectedUsersCountText.textContent = selectedCount > 0
                        ? `Đã chọn ${selectedCount.toLocaleString('vi-VN')} người dùng.`
                        : 'Đã chọn 0 người dùng.';
                }

                const hasSelection = selectedCount > 0;
                if (bulkEditBtn) {
                    bulkEditBtn.disabled = !hasSelection || !bulkUserModal;
                }
                if (clearSelectionBtn) {
                    clearSelectionBtn.disabled = !hasSelection;
                }

                if (selectAllUsersCheckbox) {
                    const checkboxes = Array.from(userTableBody?.querySelectorAll('.user-select-checkbox') ?? []);
                    const enabledCheckboxes = checkboxes.filter(cb => !cb.disabled);
                    if (enabledCheckboxes.length === 0) {
                        selectAllUsersCheckbox.checked = false;
                        selectAllUsersCheckbox.indeterminate = false;
                    } else {
                        const checkedCount = enabledCheckboxes.filter(cb => cb.checked).length;
                        selectAllUsersCheckbox.checked = checkedCount > 0 && checkedCount === enabledCheckboxes.length;
                        selectAllUsersCheckbox.indeterminate = checkedCount > 0 && checkedCount < enabledCheckboxes.length;
                    }
                }
            };

            const clearSelection = () => {
                state.selectedUserIds.clear();
                if (selectAllUsersCheckbox) {
                    selectAllUsersCheckbox.checked = false;
                    selectAllUsersCheckbox.indeterminate = false;
                }
                userTableBody?.querySelectorAll('.user-select-checkbox').forEach(cb => {
                    cb.checked = false;
                });
                updateSelectionUI();
            };

            const loadUsers = async () => {
                clearAlert(alertPlaceholder);
                userTableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-4 text-muted">Đang tải dữ liệu...</td>
                    </tr>`;
                statusText.textContent = 'Đang tải dữ liệu...';
                try {
                    const response = await fetch(`/UserManagement/users?${buildQuery()}`);
                    if (!response.ok) {
                        throw new Error('Không thể tải danh sách người dùng.');
                    }
                    const json = await response.json();
                    if (!json.success) {
                        throw new Error(json.message || 'Không thể tải danh sách người dùng.');
                    }
                    renderTable(json.data);
                } catch (error) {
                    userTableBody.innerHTML = `
                        <tr>
                            <td colspan="10" class="text-center py-4 text-danger">${error.message}</td>
                        </tr>`;
                    tableSummary.textContent = '';
                    paginationEl.innerHTML = '';
                    statusText.textContent = 'Không thể tải dữ liệu.';
                    updateSelectionUI();
                }
            };

            const loadRoles = async () => {
                if (state.rolesCache.length > 0) {
                    return state.rolesCache;
                }
                const response = await fetch('/UserManagement/roles');
                if (!response.ok) {
                    throw new Error('Không thể tải danh sách vai trò.');
                }
                const json = await response.json();
                if (!json.success) {
                    throw new Error(json.message || 'Không thể tải danh sách vai trò.');
                }
                state.rolesCache = json.data || [];
                return state.rolesCache;
            };

            const loadPermissions = async () => {
                if (state.permissionsCache.length > 0) {
                    return state.permissionsCache;
                }
                const response = await fetch('/UserManagement/permissions');
                if (!response.ok) {
                    throw new Error('Không thể tải danh sách quyền.');
                }
                const json = await response.json();
                if (!json.success) {
                    throw new Error(json.message || 'Không thể tải danh sách quyền.');
                }
                state.permissionsCache = json.data || [];
                return state.permissionsCache;
            };

            const renderTable = (paged) => {
                const items = paged.items ?? paged.Items ?? [];
                const totalItems = paged.totalItems ?? paged.TotalItems ?? 0;
                const currentPage = paged.currentPage ?? paged.CurrentPage ?? 1;
                const totalPages = paged.totalPages ?? paged.TotalPages ?? 0;
                const startItem = paged.startItem ?? paged.StartItem ?? 0;
                const endItem = paged.endItem ?? paged.EndItem ?? 0;
                const pageSize = paged.pageSize ?? paged.PageSize ?? state.pageSize;

                state.page = currentPage;
                state.pageSize = pageSize;

                if (!items || items.length === 0) {
                    userTableBody.innerHTML = `
                        <tr>
                            <td colspan="10" class="text-center py-4 text-muted">Không có dữ liệu.</td>
                        </tr>`;
                    tableSummary.textContent = 'Không có dữ liệu để hiển thị.';
                    paginationEl.innerHTML = '';
                    statusText.textContent = 'Không có dữ liệu.';
                    updateSelectionUI();
                    return;
                }

                const rows = items.map(user => {
                    const statusBadge = user.isLockedOut
                        ? '<span class="badge bg-danger-subtle text-danger">Đang khóa</span>'
                        : '<span class="badge bg-success-subtle text-success">Hoạt động</span>';
                    const lockoutText = user.lockoutEnd
                        ? formatDateTime(user.lockoutEnd)
                        : '<span class="text-muted">Không</span>';
                    const roles = (user.roles || []).join(', ') || '<span class="text-muted">Chưa gán</span>';
                    const superAdminIcon = user.isSuperAdmin
                        ? '<span class="badge bg-warning text-dark ms-1">Superadmin</span>'
                        : '';
                    const isSuperAdmin = Boolean(user.isSuperAdmin);
                    if (isSuperAdmin && state.selectedUserIds.has(user.id)) {
                        state.selectedUserIds.delete(user.id);
                    }
                    const isSelected = state.selectedUserIds.has(user.id);
                    const checkboxHtml = isSuperAdmin
                        ? '<div class="form-check m-0" title="Không thể chọn superadmin"><input class="form-check-input" type="checkbox" disabled></div>'
                        : `<div class="form-check m-0"><input class="form-check-input user-select-checkbox" type="checkbox" data-id="${user.id}" ${isSelected ? 'checked' : ''}></div>`;
                    const leaderboardBadge = user.excludeFromLeaderboard
                        ? '<span class="badge bg-secondary">Ẩn BXH</span>'
                        : '<span class="badge bg-success">Hiển thị</span>';
                    const boosterText = formatBooster(user.booster);

                    return `
                        <tr data-user-id="${user.id}" data-superadmin="${isSuperAdmin ? 'true' : 'false'}">
                            <td class="text-center align-middle">${checkboxHtml}</td>
                            <td>${user.email ?? ''}</td>
                            <td>${user.userName ?? ''}</td>
                            <td>${user.fullName ?? ''}</td>
                            <td>${roles}${superAdminIcon}</td>
                            <td>${leaderboardBadge}</td>
                            <td>${boosterText}</td>
                            <td>${statusBadge}</td>
                            <td>${lockoutText}</td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-outline-primary" data-action="detail" data-id="${user.id}"><i class="fas fa-pen"></i></button>
                            </td>
                        </tr>`;
                }).join('');

                userTableBody.innerHTML = rows;
                updateSelectionUI();
                tableSummary.textContent = `Hiển thị ${startItem} - ${endItem} / ${totalItems} người dùng.`;
                renderPagination(currentPage, totalPages);
                const totalPageCount = totalPages && totalPages > 0 ? totalPages : 1;
                statusText.textContent = `Trang ${currentPage} / ${totalPageCount} · Tổng ${totalItems.toLocaleString('vi-VN')} người dùng`;
            };

            const renderPagination = (currentPage, totalPages) => {
                paginationEl.innerHTML = '';
                if (!totalPages || totalPages <= 1) {
                    return;
                }

                const createItem = (page, label, disabled = false, active = false) => {
                    const li = document.createElement('li');
                    li.className = `page-item${disabled ? ' disabled' : ''}${active ? ' active' : ''}`;
                    const a = document.createElement('a');
                    a.className = 'page-link';
                    a.href = '#';
                    a.dataset.page = page;
                    a.textContent = label;
                    li.appendChild(a);
                    return li;
                };

                paginationEl.appendChild(createItem(currentPage - 1, '«', currentPage === 1));
                for (let page = 1; page <= totalPages; page++) {
                    paginationEl.appendChild(createItem(page, page, false, page === currentPage));
                }
                paginationEl.appendChild(createItem(currentPage + 1, '»', currentPage === totalPages));
            };

            const renderRoles = (roles, selectedRoles, disabled) => {
                roleContainer.innerHTML = '';
                if (!roles || roles.length === 0) {
                    roleContainer.innerHTML = '<div class="text-muted">Không có vai trò nào.</div>';
                    return;
                }
                const selectedSet = new Set(selectedRoles || []);
                roles.forEach(role => {
                    const col = document.createElement('div');
                    col.className = 'col-12 col-sm-6 col-lg-4';
                    const checkboxId = `userRole_${role.id}`;
                    col.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input user-role-checkbox" type="checkbox" value="${role.name}" id="${checkboxId}" ${selectedSet.has(role.name) ? 'checked' : ''} ${disabled ? 'disabled' : ''}>
                            <label class="form-check-label" for="${checkboxId}">${role.name}</label>
                        </div>`;
                    roleContainer.appendChild(col);
                });
            };

            const renderPermissions = (permissions, disabled) => {
                permissionContainer.innerHTML = '';
                if (!permissions || permissions.length === 0) {
                    permissionContainer.innerHTML = '<div class="text-muted">Không có quyền khả dụng.</div>';
                    return;
                }

                const groups = permissions.reduce((acc, permission) => {
                    const group = permission.group ?? permission.Group;
                    acc[group] = acc[group] || [];
                    acc[group].push(permission);
                    return acc;
                }, {});

                Object.entries(groups).forEach(([groupName, items]) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'mb-3';
                    const title = document.createElement('div');
                    title.className = 'fw-semibold mb-2';
                    title.textContent = groupName;
                    wrapper.appendChild(title);

                    const row = document.createElement('div');
                    row.className = 'row g-2';
                    items.forEach(item => {
                        const col = document.createElement('div');
                        col.className = 'col-12 col-sm-6 col-lg-4';
                        col.dataset.permissionItem = 'true';
                        const checkboxId = `permission_${item.key ?? item.Key}`;
                        const isSelected = item.isSelected ?? item.IsSelected;
                        const isInherited = item.isInherited ?? item.IsInherited;
                        col.innerHTML = `
                            <div class="form-check ${isInherited ? 'text-muted' : ''}">
                                <input class="form-check-input user-permission-checkbox" type="checkbox" value="${item.key ?? item.Key}" id="${checkboxId}" data-permission-key="${item.key ?? item.Key}" data-is-inherited="${isInherited ? 'true' : 'false'}" ${isSelected ? 'checked' : ''} ${disabled ? 'disabled' : ''}>
                                <label class="form-check-label" for="${checkboxId}">${item.displayName ?? item.DisplayName}${isInherited ? ' <span class="badge bg-light text-secondary ms-1">từ vai trò</span>' : ''}</label>
                            </div>`;
                        row.appendChild(col);
                    });
                    wrapper.appendChild(row);
                    permissionContainer.appendChild(wrapper);
                });

                updatePermissionVisibility();
            };

            const renderBulkRoles = (roles) => {
                if (!bulkRolesContainer) {
                    return;
                }

                bulkRolesContainer.innerHTML = '';

                if (!roles || roles.length === 0) {
                    bulkRolesContainer.innerHTML = '<div class="text-muted small">Không có vai trò nào.</div>';
                    return;
                }

                const row = document.createElement('div');
                row.className = 'row g-2';
                roles.forEach(role => {
                    const col = document.createElement('div');
                    col.className = 'col-12 col-sm-6 col-lg-4';
                    const checkboxId = `bulkRole_${role.id}`;
                    col.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input bulk-role-checkbox" type="checkbox" value="${role.name}" id="${checkboxId}">
                            <label class="form-check-label" for="${checkboxId}">${role.name}</label>
                        </div>`;
                    row.appendChild(col);
                });

                bulkRolesContainer.appendChild(row);
            };

            const renderBulkPermissions = (permissions) => {
                if (!bulkPermissionsContainer) {
                    return;
                }

                bulkPermissionsContainer.innerHTML = '';

                if (!permissions || permissions.length === 0) {
                    bulkPermissionsContainer.innerHTML = '<div class="text-muted small">Không có quyền khả dụng.</div>';
                    return;
                }

                const groups = permissions.reduce((acc, permission) => {
                    const group = permission.group ?? permission.Group;
                    (acc[group] = acc[group] || []).push(permission);
                    return acc;
                }, {});

                Object.entries(groups).forEach(([groupName, items]) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'mb-3';
                    const title = document.createElement('div');
                    title.className = 'fw-semibold mb-2';
                    title.textContent = groupName;
                    wrapper.appendChild(title);

                    const row = document.createElement('div');
                    row.className = 'row g-2';
                    items.forEach(item => {
                        const col = document.createElement('div');
                        col.className = 'col-12 col-sm-6 col-lg-4';
                        const key = item.key ?? item.Key;
                        const checkboxId = `bulkPermission_${key}`;
                        const displayName = item.displayName ?? item.DisplayName ?? key;
                        col.innerHTML = `
                            <div class="form-check">
                                <input class="form-check-input bulk-permission-checkbox" type="checkbox" value="${key}" id="${checkboxId}">
                                <label class="form-check-label" for="${checkboxId}">${displayName}</label>
                            </div>`;
                        row.appendChild(col);
                    });

                    wrapper.appendChild(row);
                    bulkPermissionsContainer.appendChild(wrapper);
                });
            };

            permissionContainer.addEventListener('change', (event) => {
                const checkbox = event.target.closest('.user-permission-checkbox');
                if (!checkbox || checkbox.disabled) {
                    return;
                }
                checkbox.dataset.isInherited = 'false';
                updatePermissionVisibility();
            });

            const getBulkSelectedRoles = () => Array.from(bulkRolesContainer?.querySelectorAll('.bulk-role-checkbox:checked') ?? []).map(cb => cb.value);

            const getBulkSelectedPermissions = () => Array.from(bulkPermissionsContainer?.querySelectorAll('.bulk-permission-checkbox:checked') ?? []).map(cb => cb.value);

            const openBulkModal = async () => {
                if (!bulkUserModal) {
                    return;
                }

                const selectedIds = Array.from(state.selectedUserIds);
                if (selectedIds.length === 0) {
                    return;
                }

                clearAlert(bulkUserAlert);

                if (bulkSelectedCount) {
                    bulkSelectedCount.textContent = selectedIds.length.toLocaleString('vi-VN');
                }

                if (bulkApplyRoles) {
                    bulkApplyRoles.checked = false;
                }
                if (bulkRolesContainer) {
                    bulkRolesContainer.classList.add('d-none');
                    bulkRolesContainer.innerHTML = '<div class="text-muted small">Đang tải vai trò...</div>';
                }

                if (bulkApplyPermissions) {
                    bulkApplyPermissions.checked = false;
                }
                if (bulkPermissionsContainer) {
                    bulkPermissionsContainer.classList.add('d-none');
                    bulkPermissionsContainer.innerHTML = '<div class="text-muted small">Đang tải quyền...</div>';
                }

                if (bulkApplyExclude) {
                    bulkApplyExclude.checked = false;
                }
                if (bulkExcludeCheckbox) {
                    bulkExcludeCheckbox.checked = false;
                    bulkExcludeCheckbox.disabled = true;
                }

                if (bulkApplyBooster) {
                    bulkApplyBooster.checked = false;
                }
                if (bulkBoosterInput) {
                    bulkBoosterInput.value = '1';
                    bulkBoosterInput.disabled = true;
                }

                if (bulkLockActionSelect) {
                    bulkLockActionSelect.value = 'none';
                }
                if (bulkLockFields) {
                    bulkLockFields.classList.add('d-none');
                }
                if (bulkLockDurationValue) {
                    bulkLockDurationValue.value = '30';
                }
                if (bulkLockDurationUnit) {
                    bulkLockDurationUnit.value = 'minute';
                }

                try {
                    const [roles, permissions] = await Promise.all([loadRoles(), loadPermissions()]);
                    renderBulkRoles(roles);
                    renderBulkPermissions(permissions);
                    if (bulkRolesContainer) {
                        bulkRolesContainer.classList.add('d-none');
                    }
                    if (bulkPermissionsContainer) {
                        bulkPermissionsContainer.classList.add('d-none');
                    }
                    bulkUserModal.show();
                } catch (error) {
                    renderAlert(alertPlaceholder, error.message || 'Không thể tải dữ liệu hàng loạt.', 'danger');
                }
            };

            const openUserModal = async (userId) => {
                state.selectedUserId = userId;
                clearAlert(userModalAlert);
                superAdminWarning.classList.add('d-none');
                lockSection.classList.remove('disabled');
                lockDurationValue.disabled = false;
                lockDurationUnit.disabled = false;
                lockUserBtn.disabled = false;
                unlockUserBtn.disabled = false;
                saveUserChangesBtn.disabled = false;

                try {
                    const [roles, userResponse] = await Promise.all([
                        loadRoles(),
                        fetch(`/UserManagement/users/${userId}`)
                    ]);

                    if (!userResponse.ok) {
                        throw new Error('Không thể tải thông tin người dùng.');
                    }

                    const userJson = await userResponse.json();
                    if (!userJson.success) {
                        throw new Error(userJson.message || 'Không thể tải thông tin người dùng.');
                    }

                    const user = userJson.data;
                    state.currentPermissions = user.permissions || [];
                    state.isSuperAdmin = !!user.isSuperAdmin;

                    if (userExcludeFromLeaderboard) {
                        userExcludeFromLeaderboard.checked = !!user.excludeFromLeaderboard;
                        userExcludeFromLeaderboard.disabled = state.isSuperAdmin;
                    }

                    if (userBoosterInput) {
                        const boosterValue = Number(user.booster ?? 1);
                        userBoosterInput.value = Number.isFinite(boosterValue) && boosterValue > 0 ? boosterValue : 1;
                        syncBoosterInputValue(userBoosterInput);
                        userBoosterInput.disabled = state.isSuperAdmin;
                    }

                    userEmailEl.textContent = user.email ?? '';
                    userUserNameEl.textContent = user.userName ?? '';
                    userFullNameEl.textContent = user.fullName ?? '';
                    userStatusEl.innerHTML = user.isLockedOut
                        ? '<span class="badge bg-danger-subtle text-danger">Đang khóa</span>'
                        : '<span class="badge bg-success-subtle text-success">Hoạt động</span>';
                    userLockoutEl.innerHTML = user.lockoutEnd
                        ? formatDateTime(user.lockoutEnd)
                        : '<span class="text-muted">Không</span>';

                    renderRoles(roles, user.roles, state.isSuperAdmin);
                    renderPermissions(state.currentPermissions, state.isSuperAdmin);

                    if (state.isSuperAdmin) {
                        superAdminWarning.classList.remove('d-none');
                        lockDurationValue.disabled = true;
                        lockDurationUnit.disabled = true;
                        lockUserBtn.disabled = true;
                        unlockUserBtn.disabled = true;
                        saveUserChangesBtn.disabled = true;
                        if (userExcludeFromLeaderboard) {
                            userExcludeFromLeaderboard.disabled = true;
                        }
                        if (userBoosterInput) {
                            userBoosterInput.disabled = true;
                        }
                    } else {
                        if (userExcludeFromLeaderboard) {
                            userExcludeFromLeaderboard.disabled = false;
                        }
                        if (userBoosterInput) {
                            userBoosterInput.disabled = false;
                        }
                    }

                    userModal.show();
                } catch (error) {
                    renderAlert(alertPlaceholder, error.message || 'Không thể tải thông tin người dùng.', 'danger');
                }
            };

            const getSelectedRoles = () => Array.from(document.querySelectorAll('.user-role-checkbox:checked')).map(cb => cb.value);
            const getSelectedPermissions = () => Array.from(document.querySelectorAll('.user-permission-checkbox:checked')).map(cb => cb.value);

            const updateUserRoles = async () => {
                const roles = getSelectedRoles();
                const response = await fetch(`/UserManagement/users/${state.selectedUserId}/roles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': requestToken()
                    },
                    body: JSON.stringify(roles)
                });
                const json = await response.json();
                if (!response.ok || !json.success) {
                    throw new Error(json.message || 'Không thể cập nhật vai trò.');
                }
                return json.message || 'Đã cập nhật vai trò.';
            };

            const updateUserPermissions = async () => {
                const permissions = getSelectedPermissions();
                const response = await fetch(`/UserManagement/users/${state.selectedUserId}/permissions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': requestToken()
                    },
                    body: JSON.stringify(permissions)
                });
                const json = await response.json();
                if (!response.ok || !json.success) {
                    throw new Error(json.message || 'Không thể cập nhật quyền.');
                }
                return json.message || 'Đã cập nhật quyền.';
            };

            const updateUserSettings = async () => {
                if (state.isSuperAdmin) {
                    return null;
                }

                if (!userExcludeFromLeaderboard || !userBoosterInput) {
                    return null;
                }

                const exclude = userExcludeFromLeaderboard.checked;
                const boosterValue = syncBoosterInputValue(userBoosterInput);
                if (!Number.isFinite(boosterValue) || boosterValue <= 0) {
                    throw new Error('Booster phải lớn hơn 0.');
                }

                const response = await fetch(`/UserManagement/users/${state.selectedUserId}/settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': requestToken()
                    },
                    body: JSON.stringify({
                        excludeFromLeaderboard: exclude,
                        booster: boosterValue
                    })
                });

                const json = await response.json();
                if (!response.ok || !json.success) {
                    throw new Error(json.message || 'Không thể cập nhật thiết lập.');
                }

                return json.message || 'Đã cập nhật thiết lập.';
            };

            saveUserChangesBtn.addEventListener('click', async () => {
                if (!state.selectedUserId) {
                    return;
                }
                clearAlert(userModalAlert);
                saveUserChangesBtn.disabled = true;
                saveUserChangesBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang lưu...';
                try {
                    const messages = [];
                    messages.push(await updateUserRoles());
                    messages.push(await updateUserPermissions());
                    if (!state.isSuperAdmin) {
                        const settingsMessage = await updateUserSettings();
                        if (settingsMessage) {
                            messages.push(settingsMessage);
                        }
                    }
                    renderAlert(userModalAlert, messages.join('<br/>'));
                    loadUsers();
                } catch (error) {
                    renderAlert(userModalAlert, error.message || 'Không thể lưu thay đổi.', 'danger');
                } finally {
                    saveUserChangesBtn.disabled = false;
                    saveUserChangesBtn.innerHTML = '<i class="fas fa-save me-1"></i>Lưu thay đổi';
                }
            });

            lockUserBtn.addEventListener('click', async () => {
                if (!state.selectedUserId) {
                    return;
                }
                clearAlert(userModalAlert);
                const durationValue = parseInt(lockDurationValue.value, 10);
                if (Number.isNaN(durationValue) || durationValue <= 0) {
                    renderAlert(userModalAlert, 'Thời gian khóa phải lớn hơn 0.', 'danger');
                    return;
                }
                lockUserBtn.disabled = true;
                lockUserBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang khóa...';
                try {
                    const response = await fetch(`/UserManagement/users/${state.selectedUserId}/lock`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': requestToken()
                        },
                        body: JSON.stringify({
                            userId: state.selectedUserId,
                            durationValue,
                            durationUnit: lockDurationUnit.value,
                            unlock: false
                        })
                    });
                    const json = await response.json();
                    if (!response.ok || !json.success) {
                        throw new Error(json.message || 'Không thể khóa tài khoản.');
                    }
                    renderAlert(userModalAlert, json.message || 'Đã khóa tài khoản.');
                    await openUserModal(state.selectedUserId);
                    loadUsers();
                } catch (error) {
                    renderAlert(userModalAlert, error.message || 'Không thể khóa tài khoản.', 'danger');
                } finally {
                    lockUserBtn.disabled = false;
                    lockUserBtn.innerHTML = '<i class="fas fa-lock me-1"></i>Khóa tài khoản';
                }
            });

            unlockUserBtn.addEventListener('click', async () => {
                if (!state.selectedUserId) {
                    return;
                }
                clearAlert(userModalAlert);
                unlockUserBtn.disabled = true;
                unlockUserBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang mở khóa...';
                try {
                    const response = await fetch(`/UserManagement/users/${state.selectedUserId}/lock`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': requestToken()
                        },
                        body: JSON.stringify({
                            userId: state.selectedUserId,
                            unlock: true,
                            durationValue: 0,
                            durationUnit: lockDurationUnit.value
                        })
                    });
                    const json = await response.json();
                    if (!response.ok || !json.success) {
                        throw new Error(json.message || 'Không thể mở khóa tài khoản.');
                    }
                    renderAlert(userModalAlert, json.message || 'Đã mở khóa tài khoản.');
                    await openUserModal(state.selectedUserId);
                    loadUsers();
                } catch (error) {
                    renderAlert(userModalAlert, error.message || 'Không thể mở khóa tài khoản.', 'danger');
                } finally {
                    unlockUserBtn.disabled = false;
                    unlockUserBtn.innerHTML = '<i class="fas fa-unlock me-1"></i>Mở khóa';
                }
            });

            paginationEl.addEventListener('click', (event) => {
                const link = event.target.closest('a.page-link');
                if (!link) {
                    return;
                }
                event.preventDefault();
                const page = parseInt(link.dataset.page, 10);
                if (Number.isNaN(page) || page < 1 || page === state.page) {
                    return;
                }
                state.page = page;
                loadUsers();
            });

            searchInput.addEventListener('input', () => {
                state.keyword = searchInput.value.trim();
                state.page = 1;
                loadUsers();
            });

            statusFilter.addEventListener('change', () => {
                state.status = statusFilter.value;
                state.page = 1;
                loadUsers();
            });

            pageSizeSelect.addEventListener('change', () => {
                state.pageSize = parseInt(pageSizeSelect.value, 10);
                state.page = 1;
                loadUsers();
            });

            refreshBtn.addEventListener('click', loadUsers);

            userTableBody.addEventListener('click', (event) => {
                const button = event.target.closest('button[data-action="detail"]');
                if (!button) {
                    return;
                }
                const userId = button.dataset.id;
                openUserModal(userId);
            });

            userTableBody.addEventListener('change', (event) => {
                const checkbox = event.target.closest('.user-select-checkbox');
                if (!checkbox || checkbox.disabled) {
                    return;
                }

                const row = checkbox.closest('tr[data-user-id]');
                const userId = checkbox.dataset.id;
                const isSuperAdmin = row?.dataset.superadmin === 'true';
                if (!userId || isSuperAdmin) {
                    checkbox.checked = false;
                    return;
                }

                if (checkbox.checked) {
                    state.selectedUserIds.add(userId);
                } else {
                    state.selectedUserIds.delete(userId);
                }

                updateSelectionUI();
            });

            if (selectAllUsersCheckbox) {
                selectAllUsersCheckbox.addEventListener('change', () => {
                    const shouldSelect = selectAllUsersCheckbox.checked;
                    const checkboxes = Array.from(userTableBody.querySelectorAll('.user-select-checkbox'));
                    checkboxes.forEach(cb => {
                        if (cb.disabled) {
                            return;
                        }
                        const userId = cb.dataset.id;
                        if (!userId) {
                            return;
                        }
                        cb.checked = shouldSelect;
                        if (shouldSelect) {
                            state.selectedUserIds.add(userId);
                        } else {
                            state.selectedUserIds.delete(userId);
                        }
                    });
                    updateSelectionUI();
                });
            }

            if (bulkEditBtn) {
                bulkEditBtn.addEventListener('click', openBulkModal);
            }

            if (clearSelectionBtn) {
                clearSelectionBtn.addEventListener('click', () => {
                    clearSelection();
                });
            }

            if (bulkApplyRoles && bulkRolesContainer) {
                bulkApplyRoles.addEventListener('change', () => {
                    const enabled = bulkApplyRoles.checked;
                    bulkRolesContainer.classList.toggle('d-none', !enabled);
                    if (!enabled) {
                        bulkRolesContainer.querySelectorAll('.bulk-role-checkbox').forEach(cb => {
                            cb.checked = false;
                        });
                    }
                });
            }

            if (bulkApplyPermissions && bulkPermissionsContainer) {
                bulkApplyPermissions.addEventListener('change', () => {
                    const enabled = bulkApplyPermissions.checked;
                    bulkPermissionsContainer.classList.toggle('d-none', !enabled);
                    if (!enabled) {
                        bulkPermissionsContainer.querySelectorAll('.bulk-permission-checkbox').forEach(cb => {
                            cb.checked = false;
                        });
                    }
                });
            }

            if (bulkApplyExclude && bulkExcludeCheckbox) {
                bulkApplyExclude.addEventListener('change', () => {
                    const enabled = bulkApplyExclude.checked;
                    bulkExcludeCheckbox.disabled = !enabled;
                    if (!enabled) {
                        bulkExcludeCheckbox.checked = false;
                    }
                });
            }

            if (bulkApplyBooster && bulkBoosterInput) {
                bulkApplyBooster.addEventListener('change', () => {
                    const enabled = bulkApplyBooster.checked;
                    bulkBoosterInput.disabled = !enabled;
                    if (!enabled) {
                        bulkBoosterInput.value = '1';
                    } else {
                        syncBoosterInputValue(bulkBoosterInput);
                    }
                });

                bulkBoosterInput.addEventListener('change', () => {
                    if (bulkBoosterInput.disabled) {
                        return;
                    }
                    syncBoosterInputValue(bulkBoosterInput);
                });
            }

            if (bulkLockActionSelect && bulkLockFields) {
                bulkLockActionSelect.addEventListener('change', () => {
                    const value = bulkLockActionSelect.value;
                    const shouldShow = value === 'lock';
                    bulkLockFields.classList.toggle('d-none', !shouldShow);
                });
            }

            if (bulkUserSaveBtn) {
                bulkUserSaveBtn.addEventListener('click', async () => {
                    if (!bulkUserModal || state.selectedUserIds.size === 0) {
                        renderAlert(bulkUserAlert, 'Không có người dùng nào được chọn.', 'danger');
                        return;
                    }

                    clearAlert(bulkUserAlert);

                    const payload = {
                        userIds: Array.from(state.selectedUserIds),
                        applyRoles: !!(bulkApplyRoles && bulkApplyRoles.checked),
                        roles: [],
                        applyPermissions: !!(bulkApplyPermissions && bulkApplyPermissions.checked),
                        permissions: [],
                        applyExcludeFromLeaderboard: !!(bulkApplyExclude && bulkApplyExclude.checked),
                        excludeFromLeaderboard: null,
                        applyBooster: !!(bulkApplyBooster && bulkApplyBooster.checked),
                        booster: null,
                        applyLock: false,
                        unlock: false,
                        durationValue: null,
                        durationUnit: null
                    };

                    if (payload.applyRoles) {
                        payload.roles = getBulkSelectedRoles();
                    }

                    if (payload.applyPermissions) {
                        payload.permissions = getBulkSelectedPermissions();
                    }

                    if (payload.applyExcludeFromLeaderboard && bulkExcludeCheckbox) {
                        payload.excludeFromLeaderboard = !!bulkExcludeCheckbox.checked;
                    }

                    if (payload.applyBooster && bulkBoosterInput) {
                        const normalized = syncBoosterInputValue(bulkBoosterInput);
                        if (!Number.isFinite(normalized) || normalized <= 0) {
                            renderAlert(bulkUserAlert, 'Booster phải lớn hơn 0.', 'danger');
                            return;
                        }
                        payload.booster = normalized;
                    }

                    const lockAction = bulkLockActionSelect ? bulkLockActionSelect.value : 'none';
                    if (lockAction === 'lock') {
                        const duration = parseInt(bulkLockDurationValue.value, 10);
                        if (Number.isNaN(duration) || duration <= 0) {
                            renderAlert(bulkUserAlert, 'Thời gian khóa phải lớn hơn 0.', 'danger');
                            return;
                        }
                        payload.applyLock = true;
                        payload.unlock = false;
                        payload.durationValue = duration;
                        payload.durationUnit = bulkLockDurationUnit ? bulkLockDurationUnit.value : 'minute';
                    } else if (lockAction === 'unlock') {
                        payload.applyLock = true;
                        payload.unlock = true;
                        payload.durationValue = 0;
                        payload.durationUnit = bulkLockDurationUnit ? bulkLockDurationUnit.value : 'minute';
                    }

                    const hasChanges = payload.applyRoles || payload.applyPermissions || payload.applyExcludeFromLeaderboard || payload.applyBooster || payload.applyLock;
                    if (!hasChanges) {
                        renderAlert(bulkUserAlert, 'Vui lòng chọn ít nhất một thay đổi để áp dụng.', 'warning');
                        return;
                    }

                    bulkUserSaveBtn.disabled = true;
                    bulkUserSaveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang áp dụng...';

                    try {
                        const response = await fetch('/UserManagement/users/bulk-update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': requestToken()
                            },
                            body: JSON.stringify(payload)
                        });

                        const json = await response.json();
                        if (!response.ok || !json.success) {
                            throw new Error(json.message || 'Không thể áp dụng thay đổi.');
                        }

                        let message = json.message || 'Đã cập nhật người dùng.';
                        if (json.skipped) {
                            message += `<br/><span class="text-muted">Đã bỏ qua ${json.skipped} người dùng.</span>`;
                        }

                        if (Array.isArray(json.errors) && json.errors.length > 0) {
                            const errors = json.errors.map(error => `<li>${error}</li>`).join('');
                            message += `<br/><strong>Lỗi:</strong><ul class="mb-0 mt-2 ps-3">${errors}</ul>`;
                            renderAlert(bulkUserAlert, message, 'warning');
                        } else {
                            renderAlert(bulkUserAlert, message);
                        }

                        loadUsers();
                    } catch (error) {
                        renderAlert(bulkUserAlert, error.message || 'Không thể áp dụng thay đổi.', 'danger');
                    } finally {
                        bulkUserSaveBtn.disabled = false;
                        bulkUserSaveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Áp dụng';
                    }
                });
            }

            if (userBoosterInput) {
                userBoosterInput.addEventListener('change', () => {
                    if (userBoosterInput.disabled) {
                        return;
                    }
                    syncBoosterInputValue(userBoosterInput);
                });
            }

            userModalEl.addEventListener('hidden.bs.modal', () => {
                state.selectedUserId = null;
                state.currentPermissions = [];
            });

            loadUsers();
        })();
    </script>
}
