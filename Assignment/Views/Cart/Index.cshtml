@model Assignment.Models.Cart

@{ 
    ViewData["Title"] = "Giỏ Hàng";
    double totalPrice = 0;
    double discount = (double)(TempData["DiscountAmount"] ?? 0.0);
    string voucherCode = TempData["VoucherCode"] as string ?? string.Empty;
    int itemCount = Model.CartItems?.Count() ?? 0;
    string discountInvariant = discount.ToString(System.Globalization.CultureInfo.InvariantCulture);
    TempData.Keep("DiscountAmount");
    TempData.Keep("VoucherCode");
    var defaultImageUrl = Url.Content("~/images/default-product.svg");
}

<div class="container my-5 cart-page">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-shopping-cart"></i> Giỏ Hàng Của Bạn
            </h2>

            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["Success"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @TempData["Error"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (Model.CartItems == null || !Model.CartItems.Any())
            {
                <div class="text-center py-5">
                    <i class="fas fa-shopping-cart fa-5x text-muted mb-3"></i>
                    <h4>Giỏ hàng của bạn đang trống</h4>
                    <p class="text-muted">Hãy thêm sản phẩm vào giỏ hàng để tiếp tục mua sắm</p>
                    <a href="@Url.Action("Index", "Home")" class="btn btn-primary mt-3">
                        <i class="fas fa-shopping-bag"></i> Tiếp tục mua sắm
                    </a>
                </div>
            }
            else
            {
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <table class="table align-middle">
                                    <thead>
                                        <tr>
                                            <th class="text-center" style="width: 50px;">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="select-all" checked>
                                                </div>
                                            </th>
                                            <th>Sản phẩm</th>
                                            <th>Đơn giá</th>
                                            <th class="text-center">Số lượng</th>
                                            <th class="text-end">Thành tiền</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in Model.CartItems)
                                        {
                                            double itemUnitPrice = 0;
                                            double baseTotal = 0;
                                            double extraTotal = item.ProductExtraSelections != null && item.ProductExtraSelections.Any()
                                                ? item.ProductExtraSelections.Sum(extra => extra.UnitPrice * extra.Quantity)
                                                : 0;
                                            string itemName = "";
                                            string itemImage = "";
                                            var hasProductSelections = item.ProductTypeSelections != null && item.ProductTypeSelections.Any();
                                            var hasExtras = extraTotal > 0;

        if (item.Product != null)
        {
            itemName = item.Product.Name;
            itemImage = string.IsNullOrWhiteSpace(item.Product.ProductImageUrl)
                ? defaultImageUrl
                : item.Product.ProductImageUrl;

                                                if (hasProductSelections)
                                                {
                                                    baseTotal = item.ProductTypeSelections
                                                        .Sum(selection => selection.UnitPrice * selection.Quantity);
                                                }
                                                else
                                                {
                                                    itemUnitPrice = PriceCalculator.GetProductFinalPrice(item.Product);
                                                    baseTotal = itemUnitPrice * item.Quantity;
                                                }
                                            }
        else if (item.Combo != null)
        {
            itemUnitPrice = PriceCalculator.GetComboFinalPrice(item.Combo);
            itemName = item.Combo.Name;
            itemImage = string.IsNullOrWhiteSpace(item.Combo.ImageUrl)
                ? defaultImageUrl
                : item.Combo.ImageUrl;
            baseTotal = itemUnitPrice * item.Quantity;
        }

        if (string.IsNullOrWhiteSpace(itemImage))
        {
            itemImage = defaultImageUrl;
        }

        double displayTotal = baseTotal + extraTotal;
        string baseTotalInvariant = baseTotal.ToString(System.Globalization.CultureInfo.InvariantCulture);
        string displayTotalInvariant = displayTotal.ToString(System.Globalization.CultureInfo.InvariantCulture);
                                            totalPrice += displayTotal;

                                            <tr>
                                                <td class="text-center">
                                                    <div class="form-check">
                                                        <input type="checkbox"
                                                               class="form-check-input cart-item-checkbox"
                                                               value="@item.Id"
                                                               data-id="@item.Id"
                                                               data-total="@baseTotalInvariant"
                                                               data-has-selections="@(hasProductSelections.ToString().ToLowerInvariant())"
                                                               checked />
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <img src="@itemImage" alt="@itemName"
                                                             class="img-thumbnail me-3"
                                                             style="width: 80px; height: 80px; object-fit: cover;"
                                                             onerror="this.onerror=null;this.src='@defaultImageUrl';">
                                                        <div>
                                                            <h6 class="mb-0">@itemName</h6>
                                                            @if (item.Product != null)
                                                            {
                                                                <small class="text-muted">Sản phẩm</small>
                                                            }
                                                            else
                                                            {
                                                                <small class="text-muted">Combo</small>
                                                            }
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    @if (hasProductSelections)
                                                    {
                                                        <span class="text-muted small">Theo từng loại</span>
                                                    }
                                                    else
                                                    {
                                                        <strong>@itemUnitPrice.ToString("N0") đ</strong>
                                                    }
                                                </td>
                                                <td class="text-center">
                                                    @if (hasProductSelections)
                                                    {
                                                        <div class="fw-semibold">@item.ProductTypeSelections.Sum(selection => selection.Quantity)</div>
                                                        <small class="text-muted">Tổng theo loại</small>
                                                    }
                                                    else
                                                    {
                                                        <form asp-controller="Cart" asp-action="UpdateQuantity" method="post" class="d-inline">
                                                            @Html.AntiForgeryToken()
                                                            <input type="hidden" name="cartItemId" value="@item.Id" />
                                                            <div class="input-group" style="width: 130px; margin: auto;">
                                                                <button type="button" class="btn btn-outline-secondary btn-sm"
                                                                        onclick="this.closest('form').querySelector('input[type=number]').stepDown(); this.closest('form').submit();">
                                                                    <i class="fas fa-minus"></i>
                                                                </button>
                                                                <input type="number" name="quantity" value="@item.Quantity"
                                                                       min="1" class="form-control form-control-sm text-center"
                                                                       onchange="this.form.submit()">
                                                                <button type="button" class="btn btn-outline-secondary btn-sm"
                                                                        onclick="this.closest('form').querySelector('input[type=number]').stepUp(); this.closest('form').submit();">
                                                                    <i class="fas fa-plus"></i>
                                                                </button>
                                                            </div>
                                                        </form>
                                                    }
                                                </td>
                                                <td class="text-end">
                                                    <strong class="cart-item-total text-danger" data-item-id="@item.Id">@displayTotal.ToString("N0") đ</strong>
                                                </td>
                                                <td class="text-center">
                                                    <form asp-controller="Cart" asp-action="Remove" method="post" class="d-inline js-confirm-form"
                                                          data-confirm-message="Bạn có chắc muốn xóa sản phẩm này?"
                                                          data-confirm-button-class="btn-danger">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="cartItemId" value="@item.Id" />
                                                        <button type="submit" class="btn btn-danger btn-sm">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </form>
                                                </td>
                                            </tr>
                                            if (hasProductSelections || hasExtras)
                                            {
                                                <tr class="bg-light">
                                                    <td></td>
                                                    <td colspan="4" class="py-0">
                                                        <ul class="list-group list-group-flush selection-list">
                                                            @if (hasProductSelections)
                                                            {
                                                                foreach (var selection in item.ProductTypeSelections)
                                                                {
                                                                    var selectionName = selection.ProductType?.Name ?? "Loại sản phẩm";
                                                                    var selectionTotal = selection.UnitPrice * selection.Quantity;
                                                                    var selectionTotalInvariant = selectionTotal.ToString(System.Globalization.CultureInfo.InvariantCulture);
                                                                    <li class="list-group-item px-0 py-2 cart-selection-item" data-selection-id="@selection.Id" data-parent-id="@item.Id">
                                                                        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
                                                                            <div class="d-flex align-items-start gap-3">
                                                                                <div class="form-check mt-1">
                                                                                    <input class="form-check-input cart-selection-checkbox"
                                                                                           type="checkbox"
                                                                                           value="@selection.Id"
                                                                                           data-parent-id="@item.Id"
                                                                                           data-total="@selectionTotalInvariant"
                                                                                           checked />
                                                                                </div>
                                                                                <div>
                                                                                    <div class="fw-semibold">@selectionName</div>
                                                                                    <div class="text-muted small">Đơn giá: @selection.UnitPrice.ToString("N0") đ</div>
                                                                                </div>
                                                                            </div>
                                                                            <div class="d-flex align-items-center gap-2 selection-actions">
                                                                                <form asp-controller="Cart" asp-action="UpdateProductTypeQuantity" method="post" class="d-flex align-items-center gap-2">
                                                                                    @Html.AntiForgeryToken()
                                                                                    <input type="hidden" name="selectionId" value="@selection.Id" />
                                                                                    <div class="input-group input-group-sm" style="width: 130px;">
                                                                                        <button type="button" class="btn btn-outline-secondary"
                                                                                                onclick="this.closest('form').querySelector('input[type=number]').stepDown(); this.closest('form').submit();">
                                                                                            <i class="fas fa-minus"></i>
                                                                                        </button>
                                                                                        <input type="number" name="quantity" value="@selection.Quantity" min="1" class="form-control text-center"
                                                                                               onchange="this.form.submit()" />
                                                                                        <button type="button" class="btn btn-outline-secondary"
                                                                                                onclick="this.closest('form').querySelector('input[type=number]').stepUp(); this.closest('form').submit();">
                                                                                            <i class="fas fa-plus"></i>
                                                                                        </button>
                                                                                    </div>
                                                                                </form>
                                                                                <form asp-controller="Cart" asp-action="RemoveProductType" method="post"
                                                                                      class="js-confirm-form"
                                                                                      data-confirm-message="Bạn có chắc muốn xóa loại sản phẩm này?"
                                                                                      data-confirm-button-class="btn-danger">
                                                                                    @Html.AntiForgeryToken()
                                                                                    <input type="hidden" name="selectionId" value="@selection.Id" />
                                                                                    <button type="submit" class="btn btn-outline-danger btn-sm" aria-label="Xóa loại sản phẩm">
                                                                                        <i class="fas fa-times"></i>
                                                                                    </button>
                                                                                </form>
                                                                            </div>
                                                                            <div class="fw-semibold text-danger selection-total" data-selection-total="@selectionTotalInvariant">
                                                                                @selectionTotal.ToString("N0") đ
                                                                            </div>
                                                                        </div>
                                                                    </li>
                                                                }
                                                            }
                                                            @if (hasExtras)
                                                            {
                                                                <li class="list-group-item px-0 py-2">
                                                                    <div class="fw-semibold text-muted small text-uppercase">Sản phẩm bổ sung</div>
                                                                </li>
                                                                foreach (var extra in item.ProductExtraSelections)
                                                                {
                                                                    var extraName = extra.ProductExtra?.Name ?? "Sản phẩm bổ sung";
                                                                    var extraTotalValue = extra.UnitPrice * extra.Quantity;
                                                                    var extraTotalValueInvariant = extraTotalValue.ToString(System.Globalization.CultureInfo.InvariantCulture);
                                                                    var isSpicy = extra.ProductExtra?.IsSpicy == true;
                                                                    var isVegetarian = extra.ProductExtra?.IsVegetarian == true;
                                                                    <li class="list-group-item px-0 py-2 cart-extra-item" data-parent-id="@item.Id" data-total="@extraTotalValueInvariant">
                                                                        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
                                                                            <div class="d-flex flex-column">
                                                                                <div class="fw-semibold">@extraName</div>
                                                                                <div class="text-muted small">Đơn giá: @extra.UnitPrice.ToString("N0") đ</div>
                                                                                <div class="d-flex gap-2 mt-1">
                                                                                    @if (isSpicy)
                                                                                    {
                                                                                        <span class="badge bg-danger-subtle text-danger">Cay</span>
                                                                                    }
                                                                                    @if (isVegetarian)
                                                                                    {
                                                                                        <span class="badge bg-success-subtle text-success">Chay</span>
                                                                                    }
                                                                                </div>
                                                                            </div>
                                                                            <div class="d-flex align-items-center gap-2 selection-actions">
                                                                                <form asp-controller="Cart" asp-action="UpdateProductExtraQuantity" method="post" class="d-flex align-items-center gap-2">
                                                                                    @Html.AntiForgeryToken()
                                                                                    <input type="hidden" name="selectionId" value="@extra.Id" />
                                                                                    <div class="input-group input-group-sm" style="width: 130px;">
                                                                                        <button type="button" class="btn btn-outline-secondary"
                                                                                                onclick="this.closest('form').querySelector('input[type=number]').stepDown(); this.closest('form').submit();">
                                                                                            <i class="fas fa-minus"></i>
                                                                                        </button>
                                                                                        <input type="number" name="quantity" value="@extra.Quantity" min="1" class="form-control text-center"
                                                                                               onchange="this.form.submit()" />
                                                                                        <button type="button" class="btn btn-outline-secondary"
                                                                                                onclick="this.closest('form').querySelector('input[type=number]').stepUp(); this.closest('form').submit();">
                                                                                            <i class="fas fa-plus"></i>
                                                                                        </button>
                                                                                    </div>
                                                                                </form>
                                                                                <form asp-controller="Cart" asp-action="RemoveProductExtra" method="post"
                                                                                      class="js-confirm-form"
                                                                                      data-confirm-message="Bạn có chắc muốn xóa sản phẩm bổ sung này?"
                                                                                      data-confirm-button-class="btn-danger">
                                                                                    @Html.AntiForgeryToken()
                                                                                    <input type="hidden" name="selectionId" value="@extra.Id" />
                                                                                    <button type="submit" class="btn btn-outline-danger btn-sm" aria-label="Xóa sản phẩm bổ sung">
                                                                                        <i class="fas fa-times"></i>
                                                                                    </button>
                                                                                </form>
                                                                            </div>
                                                                            <div class="fw-semibold text-danger">
                                                                                @extraTotalValue.ToString("N0") đ
                                                                            </div>
                                                                        </div>
                                                                    </li>
                                                                }
                                                            }
                                                        </ul>
                                                    </td>
                                                    <td></td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>

                                <div class="d-flex justify-content-between mt-3">
                                    <a href="@Url.Action("Index", "Home")" class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left"></i> Tiếp tục mua sắm
                                    </a>
                                    <form asp-controller="Cart" asp-action="Clear" method="post" class="d-inline js-confirm-form"
                                          data-confirm-message="Bạn có chắc muốn xóa toàn bộ giỏ hàng?"
                                          data-confirm-button-class="btn-danger">
                                        <button type="submit" class="btn btn-outline-danger">
                                            <i class="fas fa-trash-alt"></i> Xóa giỏ hàng
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="card shadow-sm sticky-top" style="top: 20px;">
                            <div class="card-body">
                                <h5 class="card-title mb-3">Tổng đơn hàng</h5>

                                <div class="d-flex justify-content-between mb-2">
                                    <span>Tạm tính:</span>
                                    <strong id="cart-subtotal">@totalPrice.ToString("N0") đ</strong>
                                </div>

                                <div class="d-flex justify-content-between mb-2">
                                    <span>Phí vận chuyển:</span>
                                    <strong class="text-success">Miễn phí</strong>
                                </div>

                                <div class="d-flex justify-content-between mb-2">
                                    <span>VAT (15%):</span>
                                    <strong id="cart-vat">@((totalPrice * 0.15).ToString("N0")) đ</strong>
                                </div>

                                <div id="cart-discount-row" class="d-flex justify-content-between mb-2 text-success @(discount > 0 && !string.IsNullOrEmpty(voucherCode) ? string.Empty : "d-none")">
                                    <span class="text-success">
                                        @(discount > 0 && !string.IsNullOrEmpty(voucherCode) ? $"Giảm giá ({voucherCode})" : "Giảm giá")
                                    </span>
                                    <strong id="cart-discount-amount">-@discount.ToString("N0") đ</strong>
                                </div>

                                <hr>

                                <div class="d-flex justify-content-between mb-3">
                                    <h5>Tổng cộng:</h5>
                                    <h5 class="text-danger" id="cart-total">@((totalPrice - discount + (totalPrice - discount) * 0.15).ToString("N0")) đ</h5>
                                </div>

                                <form asp-controller="Cart" asp-action="ProceedToCheckout" method="post" id="proceedCheckoutForm" class="d-grid">
                                    @Html.AntiForgeryToken()
                                    <div id="selected-items-container"></div>
                                    <div id="selected-selections-container"></div>
                                    <button type="submit" class="btn btn-primary w-100 mb-2" id="proceedCheckoutBtn">
                                        <i class="fas fa-credit-card"></i> Tiến hành thanh toán
                                    </button>
                                </form>

                                <div id="noSelectionWarning" class="alert alert-warning mt-2 d-none" role="alert">
                                    Vui lòng chọn ít nhất một sản phẩm để thanh toán.
                                </div>

                                <div class="text-center mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-shield-alt"></i> Thanh toán an toàn và bảo mật
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<div class="modal fade" id="cartConfirmationModal" tabindex="-1" aria-labelledby="cartConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cartConfirmationModalLabel">Xác nhận hành động</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0" id="cartConfirmationModalMessage">Bạn có chắc chắn muốn tiếp tục?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="cartConfirmationConfirmButton">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('input[name="quantity"]').on('change', function () {
                const value = parseInt($(this).val(), 10);
                if (isNaN(value) || value < 1) {
                    $(this).val(1);
                    this.form.submit();
                }
            });

            const VAT_RATE = 0.15;
            const baseDiscount = parseFloat('@discountInvariant');
            const totalItemCount = @itemCount;

            const checkboxes = $('.cart-item-checkbox');
            const selectionCheckboxes = $('.cart-selection-checkbox');
            const selectAll = $('#select-all');
            const subtotalElement = $('#cart-subtotal');
            const vatElement = $('#cart-vat');
            const totalElement = $('#cart-total');
            const discountRow = $('#cart-discount-row');
            const discountAmountElement = $('#cart-discount-amount');
            const proceedForm = $('#proceedCheckoutForm');
            const selectedItemsContainer = $('#selected-items-container');
            const selectedSelectionsContainer = $('#selected-selections-container');
            const proceedButton = $('#proceedCheckoutBtn');
            const noSelectionWarning = $('#noSelectionWarning');

            function formatCurrency(value) {
                return Number(value || 0).toLocaleString('vi-VN', { maximumFractionDigits: 0 }) + ' đ';
            }

            function getNumericValue(element, attributeName) {
                if (!element || !element.length) {
                    return 0;
                }

                const rawValue = element.attr(attributeName);

                if (rawValue === undefined || rawValue === null) {
                    return 0;
                }

                const normalized = String(rawValue).trim();

                if (normalized === '') {
                    return 0;
                }

                let parsed = Number(normalized);

                if (!Number.isFinite(parsed)) {
                    const fallback = Number(normalized.replace(/\./g, '').replace(/,/g, '.'));
                    parsed = Number.isFinite(fallback) ? fallback : 0;
                }

                return parsed;
            }

            function getSelectionCheckboxes(itemId) {
                return selectionCheckboxes.filter(function () {
                    return String($(this).data('parentId')) === String(itemId);
                });
            }

            function itemHasSelections(checkbox) {
                const value = checkbox.data('hasSelections');
                return value === true || value === 'true';
            }

            function updateSelectionVisualState(selectionCheckbox) {
                const selectionItem = selectionCheckbox.closest('.cart-selection-item');
                const isChecked = selectionCheckbox.is(':checked');
                selectionItem.toggleClass('selection-disabled', !isChecked);
                selectionItem.find('.selection-actions input, .selection-actions button').prop('disabled', !isChecked);
            }

            function syncItemCheckboxState(itemId) {
                const itemCheckbox = checkboxes.filter(function () {
                    return String($(this).data('id')) === String(itemId);
                });

                if (!itemCheckbox.length) {
                    return;
                }

                const relatedSelections = getSelectionCheckboxes(itemId);
                if (!relatedSelections.length) {
                    return;
                }

                const checkedCount = relatedSelections.filter(':checked').length;
                if (checkedCount === 0) {
                    itemCheckbox.prop('checked', false).prop('indeterminate', false);
                } else if (checkedCount === relatedSelections.length) {
                    itemCheckbox.prop('checked', true).prop('indeterminate', false);
                } else {
                    itemCheckbox.prop('checked', true).prop('indeterminate', true);
                }
            }

            function calculateSelectionSubtotal(itemId) {
                let total = 0;
                let checkedCount = 0;

                getSelectionCheckboxes(itemId).each(function () {
                    const checkbox = $(this);
                    if (checkbox.is(':checked')) {
                        total += getNumericValue(checkbox, 'data-total');
                        checkedCount++;
                    }
                });

                return {
                    total,
                    hasChecked: checkedCount > 0
                };
            }

            function getItemExtrasTotal(itemId) {
                let total = 0;

                $('.cart-extra-item[data-parent-id="' + itemId + '"]').each(function () {
                    total += getNumericValue($(this), 'data-total');
                });

                return total;
            }

            function getItemSelectionState(checkbox) {
                const itemId = checkbox.data('id');
                const hasSelections = itemHasSelections(checkbox);
                const selectionSubtotal = hasSelections ? calculateSelectionSubtotal(itemId) : null;
                const hasCheckedSelections = selectionSubtotal ? selectionSubtotal.hasChecked : false;
                const isBaseChecked = checkbox.is(':checked');
                const isActive = hasSelections ? hasCheckedSelections : isBaseChecked;

                return {
                    itemId,
                    hasSelections,
                    selectionSubtotal,
                    hasCheckedSelections,
                    isActive,
                    isBaseChecked
                };
            }

            function updateItemTotalDisplay(itemId, value) {
                const element = $('.cart-item-total[data-item-id="' + itemId + '"]');
                if (!element.length) {
                    return;
                }

                element.text(formatCurrency(value));
            }

            function updateSummary() {
                let subtotal = 0;
                let selectedCount = 0;

                checkboxes.each(function () {
                    const checkbox = $(this);
                    const state = getItemSelectionState(checkbox);
                    const baseTotal = getNumericValue(checkbox, 'data-total');
                    const extrasTotal = getItemExtrasTotal(state.itemId);

                    if (!state.isActive) {
                        updateItemTotalDisplay(state.itemId, 0);
                        return;
                    }

                    if (state.hasSelections) {
                        if (!state.selectionSubtotal || !state.selectionSubtotal.hasChecked) {
                            updateItemTotalDisplay(state.itemId, 0);
                            return;
                        }

                        const combinedTotal = state.selectionSubtotal.total + extrasTotal;
                        subtotal += combinedTotal;
                        updateItemTotalDisplay(state.itemId, combinedTotal);
                        if (combinedTotal > 0) {
                            selectedCount++;
                        }
                    } else {
                        if (!state.isBaseChecked) {
                            updateItemTotalDisplay(state.itemId, 0);
                            return;
                        }

                        const combinedTotal = baseTotal + extrasTotal;
                        subtotal += combinedTotal;
                        updateItemTotalDisplay(state.itemId, combinedTotal);
                        if (combinedTotal > 0) {
                            selectedCount++;
                        }
                    }
                });

                const hasDiscount = baseDiscount > 0 && totalItemCount > 0 && selectedCount === totalItemCount;
                const appliedDiscount = hasDiscount ? Math.min(baseDiscount, subtotal) : 0;
                const vat = subtotal * VAT_RATE;
                const total = subtotal - appliedDiscount + vat;

                subtotalElement.text(formatCurrency(subtotal));
                vatElement.text(formatCurrency(vat));

                if (hasDiscount && appliedDiscount > 0) {
                    discountRow.removeClass('d-none');
                    discountAmountElement.text('-' + formatCurrency(appliedDiscount));
                } else {
                    discountRow.addClass('d-none');
                    discountAmountElement.text('');
                }

                totalElement.text(formatCurrency(total));

                proceedButton.prop('disabled', selectedCount === 0);
                noSelectionWarning.toggleClass('d-none', selectedCount !== 0);

                if (selectedCount === checkboxes.length && checkboxes.length > 0) {
                    selectAll.prop('checked', true).prop('indeterminate', false);
                } else if (selectedCount === 0) {
                    selectAll.prop('checked', false).prop('indeterminate', false);
                } else {
                    selectAll.prop('indeterminate', true).prop('checked', false);
                }
            }

            selectAll.on('change', function () {
                const isChecked = $(this).is(':checked');
                selectAll.prop('indeterminate', false);

                checkboxes.each(function () {
                    const itemCheckbox = $(this);
                    const itemId = itemCheckbox.data('id');
                    const hasSelections = itemHasSelections(itemCheckbox);

                    itemCheckbox.prop('checked', isChecked);

                    if (hasSelections) {
                        const relatedSelections = getSelectionCheckboxes(itemId);
                        relatedSelections.each(function () {
                            const selectionCheckbox = $(this);
                            selectionCheckbox.prop('checked', isChecked);
                            updateSelectionVisualState(selectionCheckbox);
                        });
                        itemCheckbox.prop('indeterminate', false);
                    }
                });

                updateSummary();
            });

            checkboxes.on('change', function () {
                const checkbox = $(this);
                const itemId = checkbox.data('id');
                const hasSelections = itemHasSelections(checkbox);
                const isChecked = checkbox.is(':checked');

                if (hasSelections) {
                    const relatedSelections = getSelectionCheckboxes(itemId);
                    relatedSelections.each(function () {
                        const selectionCheckbox = $(this);
                        selectionCheckbox.prop('checked', isChecked);
                        updateSelectionVisualState(selectionCheckbox);
                    });
                    checkbox.prop('indeterminate', false);
                }

                updateSummary();
            });

            selectionCheckboxes.on('change', function () {
                const selectionCheckbox = $(this);
                updateSelectionVisualState(selectionCheckbox);
                syncItemCheckboxState(selectionCheckbox.data('parentId'));
                updateSummary();
            });

            proceedForm.on('submit', function (event) {
                selectedItemsContainer.empty();
                selectedSelectionsContainer.empty();

                const selectedIds = [];
                const selectedSelectionIds = new Set();

                checkboxes.each(function () {
                    const checkbox = $(this);
                    const state = getItemSelectionState(checkbox);

                    if (!state.isActive) {
                        return;
                    }

                    if (state.hasSelections) {
                        const checkedSelections = getSelectionCheckboxes(state.itemId).filter(':checked');
                        if (!checkedSelections.length) {
                            return;
                        }

                        selectedIds.push(state.itemId);

                        checkedSelections.each(function () {
                            const selectionId = $(this).val();
                            if (selectionId) {
                                selectedSelectionIds.add(selectionId);
                            }
                        });
                    } else {
                        selectedIds.push(state.itemId);
                    }
                });

                if (!selectedIds.length) {
                    event.preventDefault();
                    updateSummary();
                    return;
                }

                selectedIds.forEach(function (id) {
                    $('<input>', {
                        type: 'hidden',
                        name: 'selectedItemIds',
                        value: id
                    }).appendTo(selectedItemsContainer);
                });

                Array.from(selectedSelectionIds).forEach(function (id) {
                    $('<input>', {
                        type: 'hidden',
                        name: 'selectedSelectionIds',
                        value: id
                    }).appendTo(selectedSelectionsContainer);
                });
            });

            selectionCheckboxes.each(function () {
                updateSelectionVisualState($(this));
            });

            const processedItemIds = new Set();
            selectionCheckboxes.each(function () {
                const itemId = $(this).data('parentId');
                if (!processedItemIds.has(itemId)) {
                    processedItemIds.add(itemId);
                    syncItemCheckboxState(itemId);
                }
            });

            const confirmationModalElement = document.getElementById('cartConfirmationModal');
            const confirmationMessageElement = document.getElementById('cartConfirmationModalMessage');
            let confirmationModalInstance = null;
            let pendingConfirmationForm = null;

            if (confirmationModalElement) {
                const confirmationButton = $('#cartConfirmationConfirmButton');
                confirmationModalInstance = new bootstrap.Modal(confirmationModalElement);

                $('.js-confirm-form').on('submit', function (event) {
                    const form = this;

                    if (form.dataset.skipConfirm === 'true') {
                        form.dataset.skipConfirm = 'false';
                        return;
                    }

                    event.preventDefault();
                    pendingConfirmationForm = form;

                    const message = form.dataset.confirmMessage || 'Bạn có chắc chắn muốn thực hiện hành động này?';
                    if (confirmationMessageElement) {
                        confirmationMessageElement.textContent = message;
                    }

                    const buttonClass = form.dataset.confirmButtonClass || 'btn-danger';
                    confirmationButton.attr('class', 'btn ' + buttonClass);

                    confirmationModalInstance.show();
                });

                confirmationButton.on('click', function () {
                    if (!pendingConfirmationForm) {
                        return;
                    }

                    const form = pendingConfirmationForm;
                    pendingConfirmationForm = null;
                    form.dataset.skipConfirm = 'true';

                    if (typeof form.requestSubmit === 'function') {
                        form.requestSubmit();
                    } else {
                        form.submit();
                    }

                    confirmationModalInstance.hide();
                });

                confirmationModalElement.addEventListener('hidden.bs.modal', function () {
                    pendingConfirmationForm = null;
                });
            } else {
                $('.js-confirm-form').on('submit', function () {
                    return window.confirm(this.dataset.confirmMessage || 'Bạn có chắc chắn muốn thực hiện hành động này?');
                });
            }

            updateSummary();
        });
    </script>
}

